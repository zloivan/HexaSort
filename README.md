# HexaSort

Головоломка на Unity с механикой автоматического слияния цветных плиток на гексагональной сетке.

## Время разработки

**4 дня**

## Паттерны проектирования

Singleton.
Ты используешь его для BoardGrid и MergeController, чтобы иметь единый точка-доступ к двум самым центральным системам. Да, глобальность — это зло в теории, но в маленькой игре оно упрощает жизнь, всё ок.

Strategy.
IMergeRule и конкретные реализации (ConsolidationRule, InboundRule, OutboundRule) — это твой способ подсовывать разные алгоритмы слияния без переписывания основного кода. Нужно новое правило? Пиши класс, подключай — done.

Factory.
ColoredTileFactory отвечает за создание тайлов и сразу следит, чтобы цвета были валидные. Удобно, чтобы вся логика создания была в одном месте, а не размазана по сцене.

Observer.
События OnNewStackPlaced и OnStackRemoved позволяют BoardGrid просто сообщать миру “эй, тут что-то появилось / исчезло”, и при этом никак не знать, кто там дальше слушает. HandProvider, UI, эффекты — не важно. Красиво и развязано.

DirtyFlag.
Отвечает за обновление визуальной состовляющей стеков

## Небычности в кодстайле

**Методы-обработчики событий:**
- Формат `ИмяКласса_ИмяСобытия`: `BoardGrid_OnNewStackPlaced`

## Классы и их ответственность

### Grid System

- **`GridSystemHex<T>`** - Гексагональная сетка. Координаты → мировые позиции, поиск соседей, offset для четных/нечетных рядов
- **`GridPosition`** - Структура координат (X, Z)
- **`GridObject`** - Контейнер для TileStack на сетке
- **`GridDebugObject`** - Визуальный дебаг сетки

### Board System

- **`BoardGrid`** - Главный контроллер поля. Размещение/удаление стеков, валидация позиций, события
- **`BoardGridVisual`** - Визуализация сетки, подсветка ячеек при наведении
- **`BoardGridVisualSingle`** - Одна ячейка визуализации

### Merge System

- **`MergeController`** - Оркестратор слияний. Запуск каскадов, контроль последовательности, проверка уничтожения (10+ плиток)
- **`MergeAnalyzer`** - Анализ и поиск операций. Применяет все правила, сортирует по score, находит affected позиции
- **`MergeExecutor`** - Выполнение операций. Перемещение плиток, удаление пустых стеков, уничтожение
- **`MergeOperation`** - Структура операции (From, To, Count, Score)

#### Rules

- **`IMergeRule`** - Интерфейс правила слияния
- **`ConsolidationRule`** - Собирает от 2+ соседей одного цвета (приоритет 500+)
- **`InboundRule`** - Притягивает плитки К размещенному стеку (приоритет 50-200)
- **`OutboundRule`** - Отправляет плитки ИЗ размещенного стека (приоритет 10-100)

### Tiles System

- **`TileStack`** - Модель стека. LIFO операции, подсчет блоков цвета, проверка монохромности
- **`ColoredTile`** - Модель плитки с цветом
- **`ColoredTileFactory`** - Создание плиток (random или по цвету)
- **`DraggableStack`** - Drag & Drop контроллер. Input, валидация, триггер слияния
- **`HandProvider`** - Генерация 3 случайных стеков. Обновление после размещения всех
- **`TileVisual`** - Визуальное представление плитки
- **`TileStackVisual`** - Базовая визуализация стека
- **`TileStackAnimatedVisual`** - Анимированная визуализация
- **`TilesVisualSpawner`** - Создание визуальных элементов для плиток

### Utilities

- **`PointerToWorld`** - Конвертация screen → world координат
- **`GameSignals`** - Система событий/сигналов - не реализованно

## Известные проблемы

1. **Input в компоненте визуализации** (`DraggableStack.cs`)**
   - Нужен отдельный InputManager (не хватило времни) - вообще делает достаточно дофига

2. **Debug код всегда активен** (`BoardGrid.cs:36`)
   - GridDebug создается в продакшене

3. **Есть баг в логике смешивания**
   - иногда стоящие рядом тайлы не совмещаются
   - иногда почему то при смешивании появляется пустой тайл в стэке что мешает убить стэк, если го опять с чем то смешать то тайл проподает.

4. **Нет анимации смешивания стеков и полиша вцэлом**
   - текущая визуализация стека просто добавляет тайлы с задержкой
   - нет вообще нигде анимаций фактически. Не исользуется дотвин вообще

5. **Нет Object Pooling**
   - Частое создание/удаление стеков и тайлов

6. **Нет уровней, только один геймплей сцена**
   - не успел реализовать

7. **Поля для игры не строится а фиксированно**
   - не успел реализовать, сейчас стэки можно ставить по всей борде - хотелось строить борду с разлоичной формой

8. **Нет бустеров**
   - не успел реализовать бустеры, однако при текущей архетектуре бустеры который уничтожают стэк или позволяют переместить стэк - легко реализвать grid.RemoveStackAtPosition и включением DraggableStack на выставленных стэках

9. **Нет UI**
   - не успел реализовать - все что нужно, добавить в нужные точки ивенты или синганалы, и обновлять UI очков после уничтожения стэка (ивнет о уничтожении стэка есть, нужно туда передавать информацию о самом стэке - извне ивент анализируем, и добавляем в счет игрока, UI отражает эти изменения, пока не решил как бы я реализовывал бы UI, может просто компоненты котоыре тупа слушают тот же ивент - меньше кода, для данного проекта самый простой и очевидный вариант)

10. **Не тестил билд((((**
    - Билд собрал как только закончил писать код, нет андройда и времени не хватило, смотрел в симулятое, свитч платформы был без ошибок и тач вроде работает корректно

## Возможные улучшения

- Object Pooling для стеков и визуалов
- Можно DI вместо Singleton (но я считаю что это оверкил, хотя замена произойдет просто так как напрямую синглтоны нигде не используются, мы через них получаем ссылки на нужный класс в старте, легко заменить на Initialize)
- ScriptableObjects для конфигурации (scores, пороги) или JSON
- Combo система с бонусами
- Добавить вращение поля при помощи вращающейся камеры (Cinemachine)
- Добавить полноценный бутстрап мейн меню и выбор уровня (ну или систему последовательной выдачи уровней)


## Геймплей

1. Получаешь 3 случайных стека
2. Размещаешь на гексагональной сетке
3. Автоматические каскадные слияния
4. 10+ плиток одного цвета → уничтожение
5. После 3 размещений → новые стеки

---

**Unity:** 2022.3.62f  
